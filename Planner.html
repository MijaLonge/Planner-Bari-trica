<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Bari√°trico Interativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Neutral Harmony -->
    <!-- Application Structure Plan: A SPA com duas se√ß√µes principais (abas): "Pr√©-Cirurgia (Despertar)" e "P√≥s-Operat√≥rio (Florescer)", controladas por JS. A estrutura foi escolhida para separar claramente as duas fases distintas da jornada. "Despertar" foca em planejamento e checklists (formul√°rios e tabelas din√¢micas) e feedback emocional via LLM. "Florescer" √© um dashboard focado em data-logging (formul√°rios de entrada), visualiza√ß√£o de dados (gr√°ficos de linha din√¢micos) e an√°lise de correla√ß√£o dos logs via LLM. O fluxo do usu√°rio √©: 1. Navegar entre as fases. 2. Registrar dados. 3. Usar os bot√µes LLM para obter insights personalizados. 4. Visualizar a evolu√ß√£o. -->
    <!-- Visualization & Content Choices: [Info: Controle de Peso/Medidas -> Goal: Rastrear mudan√ßa -> Viz: 2 Gr√°ficos de Linha (Chart.js/Canvas) -> Interaction: Formul√°rio adiciona dados ao array JS, que atualiza os gr√°ficos -> Justification: Melhor m√©todo para tend√™ncias de tempo. | Info: Consultas, Tarefas, Di√°rios (Alimentar/Emocional) -> Goal: Organizar/Registrar -> Viz: Tabelas HTML -> Interaction: Formul√°rios adicionam novas linhas (<tr>) √†s tabelas via JS DOM -> Justification: Transforma o planner est√°tico em uma ferramenta de log interativa. | Info: Reflex√µes, Metas -> Goal: Informar/Registrar/Gerar Feedback -> Viz: <textarea> e Bloco de Resultados LLM -> Interaction: Bot√£o LLM coleta dados de reflex√£o e gera sugest√µes de preparo. | Info: Logs Alimentar/Emocional -> Goal: Analisar correla√ß√µes -> Viz: Bloco de Resultados LLM -> Interaction: Bot√£o LLM coleta logs para an√°lise de tend√™ncias e sugest√µes de foco.] -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --bg-cream: #fdfaf6;
            --header-text: #047857; /* emerald-700 */
            --body-text: #374151; /* gray-700 */
            --accent: #10b981; /* emerald-500 */
            --accent-dark: #059669; /* emerald-600 */
            --card-bg: #ffffff;
            --border-color: #d1fae5; /* emerald-100 */
            --gemini-color: #4f46e5; /* indigo-600 */
            --gemini-light: #e0e7ff; /* indigo-100 */
        }
        body {
            background-color: var(--bg-cream);
            color: var(--body-text);
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3 {
            color: var(--header-text);
        }
        .nav-button {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-active {
            border-bottom-color: var(--accent);
            color: var(--header-text);
            font-weight: 600;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        .form-input, .form-textarea, .form-select {
            border: 1px solid #d1d5db; /* gray-300 */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--border-color);
            outline: none;
        }
        .btn-primary {
            background-color: var(--accent);
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--accent-dark);
        }
        .btn-gemini {
            background-color: var(--gemini-color);
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-gemini:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .loading-spinner {
            border: 4px solid var(--gemini-light);
            border-top: 4px solid var(--gemini-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Cabe√ßalho e Navega√ß√£o -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Planner Bari√°trico</h1>
            <p class="text-xl text-gray-600">Despertar & Florescer</p>
        </header>

        <nav class="flex justify-center bg-white rounded-lg shadow-sm mb-8 p-4 border border-[var(--border-color)]">
            <button id="nav-despertar" class="nav-button text-lg md:text-xl font-medium px-6 py-3 text-gray-600">
                üåü Pr√©-Cirurgia (Despertar)
            </button>
            <button id="nav-florescer" class="nav-button text-lg md:text-xl font-medium px-6 py-3 text-gray-600">
                üå∏ P√≥s-Operat√≥rio (Florescer)
            </button>
        </nav>

        <!-- Conte√∫do Principal -->
        <main>
            <!-- ======================= -->
            <!-- P√ÅGINA 1: DESPERTAR (PR√â) -->
            <!-- ======================= -->
            <section id="page-despertar" class="page-content space-y-6">
                <div class="card p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-3">Fase 1: Pr√©-Cirurgia (Despertar)</h2>
                    <p class="text-lg text-gray-700">
                        Esta √© a sua fase de prepara√ß√£o. O foco aqui √© organiza√ß√£o, autoconhecimento e planejamento emocional e log√≠stico para o grande dia. Use as ferramentas abaixo para registrar suas reflex√µes, d√∫vidas e organizar seus compromissos.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Card: Reflex√µes -->
                    <div class="card p-6 rounded-lg shadow-md space-y-4">
                        <h3 class="text-2xl font-semibold">1. Autoconhecimento e Reflex√µes</h3>
                        <div>
                            <label for="reflexao-porque" class="block text-md font-medium text-gray-700 mb-1">Por que a Cirurgia?</label>
                            <textarea id="reflexao-porque" rows="3" class="form-textarea w-full rounded-md p-2" placeholder="Qual √© a minha motiva√ß√£o mais profunda? O que espero que mude?"></textarea>
                        </div>
                        <div>
                            <label for="reflexao-gatilhos" class="block text-md font-medium text-gray-700 mb-1">Gatilhos Emocionais</label>
                            <textarea id="reflexao-gatilhos" rows="3" class="form-textarea w-full rounded-md p-2" placeholder="Quais situa√ß√µes me levam a comer em excesso hoje?"></textarea>
                        </div>
                        <div>
                            <label for="reflexao-compromisso" class="block text-md font-medium text-gray-700 mb-1">Meu Compromisso</label>
                            <textarea id="reflexao-compromisso" rows="3" class="form-textarea w-full rounded-md p-2" placeholder="Qual √© o meu n√≠vel de preparo com as mudan√ßas permanentes?"></textarea>
                        </div>

                        <button id="btn-sugestoes-preparo" class="btn-gemini w-full rounded-md p-2 font-semibold flex items-center justify-center space-x-2">
                            <span class="loading-spinner" id="loading-despertar"></span>
                            <span id="text-despertar">Gerar Sugest√µes de Preparo Emocional ‚ú®</span>
                        </button>
                        
                        <div id="resultado-despertar" class="mt-4 p-3 bg-[var(--gemini-light)] rounded-md border border-[var(--gemini-color)] hidden">
                            <h4 class="font-semibold text-[var(--gemini-color)] mb-2">Feedback do Gemini:</h4>
                            <div id="resposta-despertar" class="whitespace-pre-wrap text-sm"></div>
                        </div>

                    </div>

                    <!-- Card: Expectativas -->
                    <div class="card p-6 rounded-lg shadow-md space-y-4">
                        <h3 class="text-2xl font-semibold">4. Expectativas, Metas e Aprendizados</h3>
                        <div>
                            <label for="expectativa-maior" class="block text-md font-medium text-gray-700 mb-1">Minha Maior Expectativa</label>
                            <textarea id="expectativa-maior" rows="2" class="form-textarea w-full rounded-md p-2"></textarea>
                        </div>
                        <div>
                            <label for="expectativa-medo" class="block text-md font-medium text-gray-700 mb-1">Meu Maior Medo</label>
                            <textarea id="expectativa-medo" rows="2" class="form-textarea w-full rounded-md p-2"></textarea>
                        </div>
                        <div>
                            <label for="expectativa-aprendizado" class="block text-md font-medium text-gray-700 mb-1">O que Aprendi at√© Agora</label>
                            <textarea id="expectativa-aprendizado" rows="2" class="form-textarea w-full rounded-md p-2" placeholder="Conhecimentos sobre alimenta√ß√£o, metabolismo..."></textarea>
                        </div>
                        <div>
                            <label for="expectativa-duvidas" class="block text-md font-medium text-gray-700 mb-1">Espa√ßo para D√∫vidas (para a equipe)</label>
                            <textarea id="expectativa-duvidas" rows="2" class="form-textarea w-full rounded-md p-2"></textarea>
                        </div>
                    </div>

                    <!-- Card: Controle de Consultas -->
                    <div class="card p-6 rounded-lg shadow-md lg:col-span-1">
                        <h3 class="text-2xl font-semibold mb-4">2. Controle de Consultas e Exames</h3>
                        <form id="form-consulta" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <input id="consulta-prof" type="text" class="form-input rounded-md p-2" placeholder="Profissional / Exame" required>
                            <input id="consulta-data" type="date" class="form-input rounded-md p-2" required>
                            <input id="consulta-obs" type="text" class="form-input rounded-md p-2 sm:col-span-2" placeholder="Observa√ß√µes">
                            <button type="submit" class="btn-primary rounded-md p-2 sm:col-span-2">Adicionar Compromisso</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px]">
                                <thead class="border-b-2 border-gray-200">
                                    <tr class="text-left text-gray-600">
                                        <th class="p-2">Profissional/Exame</th>
                                        <th class="p-2">Data</th>
                                        <th class="p-2">Observa√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-consultas">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card: Planejamento Rotina -->
                    <div class="card p-6 rounded-lg shadow-md lg:col-span-1">
                        <h3 class="text-2xl font-semibold mb-4">3. Planejamento de Rotina para o Grande Dia</h3>
                        <form id="form-tarefa" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <input id="tarefa-area" type="text" class="form-input rounded-md p-2" placeholder="√Årea (Ex: Casa, Log√≠stica)" required>
                            <input id="tarefa-desc" type="text" class="form-input rounded-md p-2" placeholder="Tarefa" required>
                            <input id="tarefa-data" type="date" class="form-input rounded-md p-2">
                            <button type="submit" class="btn-primary rounded-md p-2 sm:col-span-2">Adicionar Tarefa</button>
                        </form>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px]">
                                <thead class="border-b-2 border-gray-200">
                                    <tr class="text-left text-gray-600">
                                        <th class="p-2">√Årea</th>
                                        <th class="p-2">Tarefa</th>
                                        <th class="p-2">Data Limite</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-tarefas">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ========================= -->
            <!-- P√ÅGINA 2: FLORESCER (P√ìS) -->
            <!-- ========================= -->
            <section id="page-florescer" class="page-content hidden space-y-6">
                <div class="card p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-bold mb-3">Fase 2: P√≥s-Operat√≥rio (Florescer)</h2>
                    <p class="text-lg text-gray-700">
                        A cirurgia passou e o verdadeiro processo come√ßa. Esta se√ß√£o √© seu dashboard para construir h√°bitos, acompanhar sua evolu√ß√£o e se reconectar com voc√™. Registre seu peso, medidas e di√°rios para visualizar seu progresso nos gr√°ficos.
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Coluna 1: ENTRADA DE DADOS -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Card: Entrada de Peso e Medidas -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4">Adicionar Medi√ß√£o</h3>
                            <form id="form-medidas" class="space-y-3">
                                <input id="medida-data" type="date" class="form-input w-full rounded-md p-2" required>
                                <div class="grid grid-cols-2 gap-3">
                                    <input id="medida-peso" type="number" step="0.1" class="form-input w-full rounded-md p-2" placeholder="Peso (kg)" required>
                                    <input id="medida-cintura" type="number" class="form-input w-full rounded-md p-2" placeholder="Cintura (cm)">
                                    <input id="medida-quadril" type="number" class="form-input w-full rounded-md p-2" placeholder="Quadril (cm)">
                                    <input id="medida-braco" type="number" class="form-input w-full rounded-md p-2" placeholder="Bra√ßo (cm)">
                                </div>
                                <button type="submit" class="btn-primary w-full rounded-md p-2 font-semibold">Salvar Medi√ß√£o e Atualizar Gr√°ficos</button>
                            </form>
                        </div>

                        <!-- Card: Di√°rio Alimentar -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4">3. Di√°rio Alimentar</h3>
                            <form id="form-diario-alimentar" class="space-y-3">
                                <input id="alim-data" type="date" class="form-input w-full rounded-md p-2" required>
                                <select id="alim-fase" class="form-select w-full rounded-md p-2" required>
                                    <option value="">Selecione a Fase</option>
                                    <option value="L√≠quida">L√≠quida</option>
                                    <option value="Cremosa">Cremosa</option>
                                    <option value="Pastosa">Pastosa</option>
                                    <option value="Branda">Branda</option>
                                    <option value="S√≥lida">S√≥lida</option>
                                </select>
                                <input id="alim-refeicao" type="text" class="form-input w-full rounded-md p-2" placeholder="Refei√ß√£o (Ex: Almo√ßo)" required>
                                <input id="alim-alimento" type="text" class="form-input w-full rounded-md p-2" placeholder="Alimento/Bebida" required>
                                <div class="grid grid-cols-2 gap-3">
                                    <input id="alim-volume" type="text" class="form-input w-full rounded-md p-2" placeholder="Volume (ml/g)">
                                    <select id="alim-tolerancia" class="form-select w-full rounded-md p-2" required>
                                        <option value="√ìtima">Toler√¢ncia: √ìtima</option>
                                        <option value="M√©dia">Toler√¢ncia: M√©dia</option>
                                        <option value="Ruim">Toler√¢ncia: Ruim</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary w-full rounded-md p-2 font-semibold">Registrar Refei√ß√£o</button>
                            </form>
                        </div>

                        <!-- Card: Gera√ß√£o de Receitas por Fase -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4">6. Sugest√£o de Receitas ‚ú®</h3>
                            <p class="text-sm text-gray-600 mb-3">Escolha sua fase atual e gere ideias de receitas focadas em prote√≠na e toler√¢ncia.</p>
                            <div class="space-y-3">
                                <select id="recipe-fase" class="form-select w-full rounded-md p-2" required>
                                    <option value="">Selecione a Fase Atual</option>
                                    <option value="L√≠quida">Fase L√≠quida (Ex: Caldos, Sucos coados)</option>
                                    <option value="Cremosa">Fase Cremosa (Ex: Pur√™s, Sopas cremosas)</option>
                                    <option value="Pastosa">Fase Pastosa (Ex: Ovos mexidos, Carne desfiada)</option>
                                    <option value="Branda">Fase Branda (Ex: Frango cozido, Peixe, Legumes macios)</option>
                                    <option value="S√≥lida">Fase S√≥lida (Ex: Alimenta√ß√£o regular balanceada)</option>
                                </select>
                                <button id="btn-gerar-receita" class="btn-gemini w-full rounded-md p-2 font-semibold flex items-center justify-center space-x-2">
                                    <span class="loading-spinner" id="loading-receita"></span>
                                    <span id="text-receita">Gerar Ideias de Receitas por Fase ‚ú®</span>
                                </button>
                            </div>
                            <div id="resultado-receita" class="mt-4 p-3 bg-[var(--gemini-light)] rounded-md border border-[var(--gemini-color)] hidden">
                                <h4 class="font-semibold text-[var(--gemini-color)] mb-2">Ideias do Chef Gemini:</h4>
                                <div id="resposta-receita" class="whitespace-pre-wrap text-sm"></div>
                            </div>
                        </div>

                    </div>

                    <!-- Coluna 2: GR√ÅFICOS E VISUALIZA√á√ÉO -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Card: Gr√°fico de Peso -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4 text-center">2. Evolu√ß√£o do Peso (kg)</h3>
                            <div class="chart-container">
                                <canvas id="pesoChart"></canvas>
                            </div>
                        </div>

                        <!-- Card: Gr√°fico de Medidas -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4 text-center">2. Evolu√ß√£o das Medidas (cm)</h3>
                            <div class="chart-container">
                                <canvas id="medidasChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna 3: LOGS E METAS (em 3 colunas) -->
                    <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Card: Di√°rio Emocional -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4">4. Di√°rio Emocional</h3>
                            <form id="form-diario-emocional" class="space-y-3">
                                <input id="emo-data" type="date" class="form-input w-full rounded-md p-2" required>
                                <div>
                                    <label for="emo-humor" class="block text-sm font-medium text-gray-700">Humor (1=Ruim, 5=√ìtimo)</label>
                                    <input id="emo-humor" type="range" min="1" max="5" step="1" class="w-full">
                                </div>
                                <input id="emo-foco" type="text" class="form-input w-full rounded-md p-2" placeholder="O que senti (Foco)? Ex: Ansiedade, Foco..." required>
                                <textarea id="emo-lidei" rows="2" class="form-textarea w-full rounded-md p-2" placeholder="Como lidei com a emo√ß√£o?"></textarea>
                                <textarea id="emo-gratidao" rows="2" class="form-textarea w-full rounded-md p-2" placeholder="Gratid√£o e Metas para amanh√£"></textarea>
                                <button type="submit" class="btn-primary w-full rounded-md p-2 font-semibold">Registrar Emo√ß√£o</button>
                            </form>
                        </div>
                        
                        <!-- Card: Metas e Bem-Estar -->
                        <div class="card p-6 rounded-lg shadow-md">
                            <h3 class="text-2xl font-semibold mb-4">5. Metas, Gratid√£o e Bem-Estar</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="metas-nao-escala" class="block text-md font-medium text-gray-700 mb-1">Minhas Metas de "N√£o-Escala"</label>
                                    <textarea id="metas-nao-escala" rows="3" class="form-textarea w-full rounded-md p-2" placeholder="Ex: Correr 1km, vestir uma roupa guardada..."></textarea>
                                </div>
                                
                                <h4 class="text-lg font-medium text-gray-700">Checklist de Bem-Estar Di√°rio</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="h-5 w-5 text-[var(--accent)] rounded border-gray-300 focus:ring-[var(--accent)]">
                                        <span class="ml-2 text-gray-700">30 min de exerc√≠cio/movimento</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="h-5 w-5 text-[var(--accent)] rounded border-gray-300 focus:ring-[var(--accent)]">
                                        <span class="ml-2 text-gray-700">Sono de 7-9 horas</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="h-5 w-5 text-[var(--accent)] rounded border-gray-300 focus:ring-[var(--accent)]">
                                        <span class="ml-2 text-gray-700">Medita√ß√£o / Momento de Calma</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="h-5 w-5 text-[var(--accent)] rounded border-gray-300 focus:ring-[var(--accent)]">
                                        <span class="ml-2 text-gray-700">Contato social positivo</span>
                                    </label>
                                </div>

                                <div>
                                    <label for="metas-lema" class="block text-md font-medium text-gray-700 mb-1">Meu Lema Atual</label>
                                    <input id="metas-lema" type="text" class="form-input w-full rounded-md p-2">
                                </div>
                                
                                <!-- NEW TTS FEATURE -->
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <h4 class="text-lg font-semibold text-[var(--gemini-color)] mb-2">Motiva√ß√£o por Voz ‚ú®</h4>
                                    <p class="text-sm text-gray-600 mb-3">Ou√ßa seu lema atual em voz alta para refor√ßar sua meta.</p>
                                    <button id="btn-ler-lema" class="btn-gemini w-full rounded-md p-2 font-semibold flex items-center justify-center space-x-2">
                                        <span class="loading-spinner" id="loading-tts"></span>
                                        <span id="text-tts">Ouvir Lema Motivacional</span>
                                    </button>
                                    <audio id="audio-player" class="w-full mt-3 hidden" controls></audio>
                                </div>
                                
                            </div>
                        </div>

                        <!-- Card: Logs Recentes -->
                        <div class="card p-6 rounded-lg shadow-md md:col-span-2">
                            <h3 class="text-2xl font-semibold mb-4">Registros Recentes</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-lg font-medium text-gray-700 mb-2">√öltimas Refei√ß√µes</h4>
                                    <div class="overflow-x-auto max-h-48 overflow-y-auto">
                                        <table class="w-full min-w-[400px]">
                                            <thead class="border-b-2 border-gray-200 text-left text-sm text-gray-600">
                                                <tr><th class="p-1">Data</th><th class="p-1">Refei√ß√£o</th><th class="p-1">Alimento</th><th class="p-1">Toler√¢ncia</th></tr>
                                            </thead>
                                            <tbody id="tbody-diario-alimentar"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-lg font-medium text-gray-700 mb-2">√öltimas Emo√ß√µes</h4>
                                    <div class="overflow-x-auto max-h-48 overflow-y-auto">
                                        <table class="w-full min-w-[400px]">
                                            <thead class="border-b-2 border-gray-200 text-left text-sm text-gray-600">
                                                <tr><th class="p-1">Data</th><th class="p-1">Humor</th><th class="p-1">Foco</th><th class="p-1">Como Lidei</th></tr>
                                            </thead>
                                            <tbody id="tbody-diario-emocional"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <button id="btn-analisar-logs" class="btn-gemini w-full rounded-md p-2 font-semibold flex items-center justify-center space-x-2">
                                    <span class="loading-spinner" id="loading-florescer"></span>
                                    <span id="text-florescer">Analisar Logs e Sugerir Foco ‚ú®</span>
                                </button>

                                <div id="resultado-florescer" class="mt-4 p-3 bg-[var(--gemini-light)] rounded-md border border-[var(--gemini-color)] hidden">
                                    <h4 class="font-semibold text-[var(--gemini-color)] mb-2">An√°lise de Tend√™ncia e Foco Sugerido:</h4>
                                    <div id="resposta-florescer" class="whitespace-pre-wrap text-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12 py-6 border-t border-gray-200">
            <p class="text-gray-500">Criado com foco na sua jornada. Boa sorte!</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const navDespertar = document.getElementById('nav-despertar');
            const navFlorescer = document.getElementById('nav-florescer');
            const pageDespertar = document.getElementById('page-despertar');
            const pageFlorescer = document.getElementById('page-florescer');

            const formConsulta = document.getElementById('form-consulta');
            const tbodyConsultas = document.getElementById('tbody-consultas');
            const formTarefa = document.getElementById('form-tarefa');
            const tbodyTarefas = document.getElementById('tbody-tarefas');
            
            const formMedidas = document.getElementById('form-medidas');
            const formDiarioAlimentar = document.getElementById('form-diario-alimentar');
            const tbodyDiarioAlimentar = document.getElementById('tbody-diario-alimentar');
            const formDiarioEmocional = document.getElementById('form-diario-emocional');
            const tbodyDiarioEmocional = document.getElementById('tbody-diario-emocional');

            const btnSugestoesPreparo = document.getElementById('btn-sugestoes-preparo');
            const btnAnalisarLogs = document.getElementById('btn-analisar-logs');
            const resultadoDespertar = document.getElementById('resultado-despertar');
            const respostaDespertar = document.getElementById('resposta-despertar');
            const loadingDespertar = document.getElementById('loading-despertar');
            const textDespertar = document.getElementById('text-despertar');
            const resultadoFlorescer = document.getElementById('resultado-florescer');
            const respostaFlorescer = document.getElementById('resposta-florescer');
            const loadingFlorescer = document.getElementById('loading-florescer');
            const textFlorescer = document.getElementById('text-florescer');

            const btnGerarReceita = document.getElementById('btn-gerar-receita');
            const loadingReceita = document.getElementById('loading-receita');
            const textReceita = document.getElementById('text-receita');
            const resultadoReceita = document.getElementById('resultado-receita');
            const respostaReceita = document.getElementById('resposta-receita');
            
            // New TTS elements
            const btnLerLema = document.getElementById('btn-ler-lema');
            const metasLema = document.getElementById('metas-lema');
            const loadingTts = document.getElementById('loading-tts');
            const textTts = document.getElementById('text-tts');
            const audioPlayer = document.getElementById('audio-player');


            let pesoChartInstance = null;
            let medidasChartInstance = null;
            let medicoesData = [];

            const API_KEY = ""; 
            const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
            
            // --- TTS UTILITY FUNCTIONS ---
            
            function base64ToArrayBuffer(base64) {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const pcm16 = pcmData; 
                const numChannels = 1;
                const bitsPerSample = 16;
                const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
                const blockAlign = numChannels * (bitsPerSample / 8);
                const buffer = new ArrayBuffer(44 + pcm16.byteLength);
                const view = new DataView(buffer);
                let offset = 0;

                function writeString(str) {
                    for (let i = 0; i < str.length; i++) {
                        view.setUint8(offset++, str.charCodeAt(i));
                    }
                }

                writeString('RIFF'); offset += 4; 
                view.setUint32(offset, 36 + pcm16.byteLength, true); offset += 4;
                writeString('WAVE'); offset += 4;
                writeString('fmt '); offset += 4;
                view.setUint32(offset, 16, true); offset += 4;
                view.setUint16(offset, 1, true); offset += 2;
                view.setUint16(offset, numChannels, true); offset += 2;
                view.setUint32(offset, sampleRate, true); offset += 4;
                view.setUint32(offset, byteRate, true); offset += 4;
                view.setUint16(offset, blockAlign, true); offset += 2;
                view.setUint16(offset, bitsPerSample, true); offset += 2;
                writeString('data'); offset += 4;
                view.setUint32(offset, pcm16.byteLength, true); offset += 4;
                
                const pcmBytes = new Uint8Array(pcm16.buffer);
                for(let i = 0; i < pcmBytes.length; i++) {
                    view.setUint8(offset++, pcmBytes[i]);
                }

                return new Blob([buffer], { type: 'audio/wav' });
            }

            async function callGeminiTtsApi(textToSpeak) {
                const payload = {
                    contents: [{
                        parts: [{ text: textToSpeak }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                let response = null;
                const maxRetries = 5;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(TTS_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`TTS API error: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        
                        if (part && part.inlineData) {
                            const audioData = part.inlineData.data;
                            const mimeType = part.inlineData.mimeType;
                            
                            if (mimeType.startsWith("audio/L16")) {
                                // Extract sample rate (e.g., audio/L16;rate=24000)
                                const match = mimeType.match(/rate=(\d+)/);
                                const sampleRate = match ? parseInt(match[1], 10) : 24000; 

                                const pcmBuffer = base64ToArrayBuffer(audioData);
                                const pcm16 = new Int16Array(pcmBuffer);
                                const wavBlob = pcmToWav(pcm16, sampleRate);
                                return URL.createObjectURL(wavBlob);
                            } else {
                                throw new Error("Formato de √°udio inesperado.");
                            }
                        }
                        return null;

                    } catch (error) {
                        console.error("Erro na chamada da API TTS:", error);
                        if (i === maxRetries - 1) throw error;
                    }
                }
                return null;
            }
            
            // --- REGULAR GEMINI API CALL (FOR TEXT) ---

            async function callGeminiApi(prompt, systemInstruction) {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };

                let response = null;
                const maxRetries = 5;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(API_URL_BASE, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }

                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro ao processar a resposta do LLM.";

                    } catch (error) {
                        console.error("Erro na chamada da API:", error);
                        if (i === maxRetries - 1) throw error;
                    }
                }
                return "Desculpe, a API n√£o p√¥de gerar uma resposta ap√≥s v√°rias tentativas.";
            }

            // --- L√ìGICA DO TTS: LER LEMA ---

            btnLerLema.addEventListener('click', async () => {
                const lema = metasLema.value.trim();
                
                if (lema.length === 0) {
                    audioPlayer.classList.add('hidden');
                    alert("Por favor, digite seu 'Lema Atual' antes de tentar ouvi-lo.");
                    return;
                }
                
                textTts.classList.add('hidden');
                loadingTts.style.display = 'block';
                audioPlayer.classList.add('hidden');

                const ttsPrompt = `Diga com uma voz motivadora: ${lema}`;

                try {
                    const audioUrl = await callGeminiTtsApi(ttsPrompt);
                    
                    if (audioUrl) {
                        audioPlayer.src = audioUrl;
                        audioPlayer.classList.remove('hidden');
                        audioPlayer.play();
                    } else {
                        alert("N√£o foi poss√≠vel gerar o √°udio. Tente novamente.");
                    }
                } catch (error) {
                    alert("Erro ao processar a s√≠ntese de voz. Verifique o console para detalhes.");
                } finally {
                    loadingTts.style.display = 'none';
                    textTts.classList.remove('hidden');
                }
            });


            // --- L√ìGICA DO DESPERTAR (PR√â-OP) ---

            btnSugestoesPreparo.addEventListener('click', async () => {
                const porque = document.getElementById('reflexao-porque').value;
                const gatilhos = document.getElementById('reflexao-gatilhos').value;
                const compromisso = document.getElementById('reflexao-compromisso').value;
                const expectativa = document.getElementById('expectativa-maior').value;
                const medo = document.getElementById('expectativa-medo').value;

                if (!porque && !medo) {
                    respostaDespertar.textContent = "Por favor, preencha pelo menos as se√ß√µes 'Por que a Cirurgia?' ou 'Meu Maior Medo' para que eu possa gerar sugest√µes focadas.";
                    resultadoDespertar.classList.remove('hidden');
                    return;
                }

                const prompt = `Analise as seguintes reflex√µes e medos pr√©-bari√°trica e gere uma resposta de coach motivacional (apenas texto) com 3 a 5 passos pr√°ticos e positivos de preparo emocional focado nos pontos levantados. Use bullet points. 
                - Motiva√ß√£o (Por que a Cirurgia?): ${porque}
                - Desafios (Gatilhos Emocionais): ${gatilhos}
                - Compromisso: ${compromisso}
                - Expectativa Principal: ${expectativa}
                - Maior Medo: ${medo}`;

                const systemInstruction = "Voc√™ √© um conselheiro bari√°trico experiente. Sua fun√ß√£o √© analisar as reflex√µes do paciente e fornecer um feedback emp√°tico, motivacional e com sugest√µes pr√°ticas e realistas para a prepara√ß√£o mental e emocional para a cirurgia e o p√≥s-operat√≥rio.";
                
                textDespertar.classList.add('hidden');
                loadingDespertar.style.display = 'block';
                resultadoDespertar.classList.remove('hidden');
                respostaDespertar.textContent = "Analisando suas reflex√µes... isso pode levar alguns segundos.";

                try {
                    const responseText = await callGeminiApi(prompt, systemInstruction);
                    respostaDespertar.textContent = responseText;
                } catch (error) {
                    respostaDespertar.textContent = "Ocorreu um erro ao conectar com o assistente de preparo. Tente novamente mais tarde.";
                } finally {
                    loadingDespertar.style.display = 'none';
                    textDespertar.classList.remove('hidden');
                }
            });

            // --- L√ìGICA DO FLORESCER (P√ìS-OP) - AN√ÅLISE DE LOGS ---

            btnAnalisarLogs.addEventListener('click', async () => {
                const alimentares = Array.from(tbodyDiarioAlimentar.rows).map(row => ({
                    data: row.cells[0].textContent,
                    fase: row.cells[1].textContent, 
                    alimento: row.cells[2].textContent,
                    tolerancia: row.cells[3].textContent,
                }));

                const emocionais = Array.from(tbodyDiarioEmocional.rows).map(row => ({
                    data: row.cells[0].textContent,
                    humor: row.cells[1].textContent,
                    foco: row.cells[2].textContent,
                }));

                if (alimentares.length === 0 && emocionais.length === 0) {
                    respostaFlorescer.textContent = "Por favor, registre dados no Di√°rio Alimentar e no Di√°rio Emocional para que eu possa fazer uma an√°lise.";
                    resultadoFlorescer.classList.remove('hidden');
                    return;
                }

                const alimentaresText = alimentares.map(a => 
                    `[${a.data}, Fase: ${a.fase}, Alimento: ${a.alimento}, Toler√¢ncia: ${a.tolerancia}]`
                ).join('\n');
                
                const emocionaisText = emocionais.map(e => 
                    `[${e.data}, Humor: ${e.humor}, Foco: ${e.foco}]`
                ).join('\n');

                const prompt = `Analise os logs de bem-estar p√≥s-bari√°trica e forne√ßa um breve resumo de tend√™ncia e uma sugest√£o de FOCO para a pr√≥xima semana. A an√°lise deve correlacionar a toler√¢ncia alimentar e as emo√ß√µes registradas. Formate a resposta com um t√≠tulo em negrito e 3 bullet points.
                
                Logs Alimentares (Mais Recentes Primeiro):
                ${alimentaresText}

                Logs Emocionais (Mais Recentes Primeiro):
                ${emocionaisText}`;

                const systemInstruction = "Voc√™ √© um analista de tend√™ncias de bem-estar p√≥s-bari√°trica. Seu objetivo √© identificar padr√µes (ex: 'Baixa toler√¢ncia correlacionada com ansiedade') e sugerir um √∫nico FOCO pr√°tico e motivacional (ex: 'Focar em t√©cnicas de mastiga√ß√£o', 'Aumentar a aten√ß√£o plena nas refei√ß√µes', 'Explorar exerc√≠cios de respira√ß√£o para ansiedade'). Mantenha o tom profissional e encorajador.";

                textFlorescer.classList.add('hidden');
                loadingFlorescer.style.display = 'block';
                resultadoFlorescer.classList.remove('hidden');
                respostaFlorescer.textContent = "Analisando seus logs de evolu√ß√£o... isso pode levar alguns segundos.";

                try {
                    const responseText = await callGeminiApi(prompt, systemInstruction);
                    respostaFlorescer.textContent = responseText;
                } catch (error) {
                    respostaFlorescer.textContent = "Ocorreu um erro ao conectar com o assistente de an√°lise. Tente novamente mais tarde.";
                } finally {
                    loadingFlorescer.style.display = 'none';
                    textFlorescer.classList.remove('hidden');
                }
            });

            // --- L√ìGICA DO FLORESCER (P√ìS-OP) - RECEITA ---

            btnGerarReceita.addEventListener('click', async () => {
                const fase = document.getElementById('recipe-fase').value;
                
                if (!fase) {
                    respostaReceita.textContent = "Por favor, selecione sua Fase Atual para gerar ideias de receitas.";
                    resultadoReceita.classList.remove('hidden');
                    return;
                }

                const prompt = `Gere 3 ideias de receitas (t√≠tulo, ingredientes e preparo) adequadas para a Fase ${fase} da dieta bari√°trica. Priorize alto teor de prote√≠na e facilidade de digest√£o. Use formata√ß√£o de lista para facilitar a leitura.`;

                const systemInstruction = "Voc√™ √© um nutricionista culin√°rio focado em receitas bari√°tricas. Seu objetivo √© fornecer receitas seguras, ricas em prote√≠na e adequadas √† fase alimentar do paciente (L√≠quida, Cremosa, Pastosa, Branda, S√≥lida).";
                
                textReceita.classList.add('hidden');
                loadingReceita.style.display = 'block';
                resultadoReceita.classList.remove('hidden');
                respostaReceita.textContent = `Buscando 3 ideias de receitas para a Fase ${fase}...`;

                try {
                    const responseText = await callGeminiApi(prompt, systemInstruction);
                    respostaReceita.textContent = responseText;
                } catch (error) {
                    respostaReceita.textContent = "Ocorreu um erro ao conectar com o assistente de receitas. Tente novamente mais tarde.";
                } finally {
                    loadingReceita.style.display = 'none';
                    textReceita.classList.remove('hidden');
                }
            });

            // --- FUN√á√ïES DE NAVEGA√á√ÉO E GR√ÅFICOS (ORIGINAIS) ---

            function showPage(pageId) {
                if (pageId === 'page-despertar') {
                    pageDespertar.classList.remove('hidden');
                    pageFlorescer.classList.add('hidden');
                    navDespertar.classList.add('nav-active');
                    navFlorescer.classList.remove('nav-active');
                } else {
                    pageDespertar.classList.add('hidden');
                    pageFlorescer.classList.remove('hidden');
                    navDespertar.classList.remove('nav-active');
                    navFlorescer.classList.add('nav-active');
                    initCharts();
                }
            }

            navDespertar.addEventListener('click', () => showPage('page-despertar'));
            navFlorescer.addEventListener('click', () => showPage('page-florescer'));

            showPage('page-despertar');

            function addRowToTable(tbody, cells) {
                const newRow = tbody.insertRow(0);
                cells.forEach((cellText, index) => {
                    const newCell = newRow.insertCell(index);
                    newCell.textContent = cellText || 'N/A';
                    newCell.classList.add('p-2', 'border-b', 'border-gray-100', 'text-sm');
                });
            }

            formConsulta.addEventListener('submit', (e) => {
                e.preventDefault();
                const prof = document.getElementById('consulta-prof').value;
                const data = document.getElementById('consulta-data').value;
                const obs = document.getElementById('consulta-obs').value;
                addRowToTable(tbodyConsultas, [prof, data, obs]);
                formConsulta.reset();
            });

            formTarefa.addEventListener('submit', (e) => {
                e.preventDefault();
                const area = document.getElementById('tarefa-area').value;
                const desc = document.getElementById('tarefa-desc').value;
                const data = document.getElementById('tarefa-data').value;
                addRowToTable(tbodyTarefas, [area, desc, data]);
                formTarefa.reset();
            });

            formDiarioAlimentar.addEventListener('submit', (e) => {
                e.preventDefault();
                const data = document.getElementById('alim-data').value;
                const fase = document.getElementById('alim-fase').value; 
                const refeicao = document.getElementById('alim-refeicao').value;
                const alimento = document.getElementById('alim-alimento').value;
                const tolerancia = document.getElementById('alim-tolerancia').value;
                addRowToTable(tbodyDiarioAlimentar, [data, refeicao, alimento, tolerancia]);
                formDiarioAlimentar.reset();
            });

            formDiarioEmocional.addEventListener('submit', (e) => {
                e.preventDefault();
                const data = document.getElementById('emo-data').value;
                const humor = document.getElementById('emo-humor').value;
                const foco = document.getElementById('emo-foco').value;
                const lidei = document.getElementById('emo-lidei').value;
                addRowToTable(tbodyDiarioEmocional, [data, `${humor}/5`, foco, lidei]);
                formDiarioEmocional.reset();
            });

            formMedidas.addEventListener('submit', (e) => {
                e.preventDefault();
                const data = document.getElementById('medida-data').value;
                const peso = parseFloat(document.getElementById('medida-peso').value);
                const cintura = parseFloat(document.getElementById('medida-cintura').value) || null;
                const quadril = parseFloat(document.getElementById('medida-quadril').value) || null;
                const braco = parseFloat(document.getElementById('medida-braco').value) || null;
                
                medicoesData.push({ data, peso, cintura, quadril, braco });
                medicoesData.sort((a, b) => new Date(a.data) - new Date(b.data));
                
                updateCharts();
                formMedidas.reset();
            });

            function initCharts() {
                if (pesoChartInstance) return;

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#4b5563' } },
                        y: { ticks: { color: '#4b5563' }, beginAtZero: false }
                    },
                    plugins: {
                        legend: { labels: { color: '#374151' } }
                    }
                };

                const ctxPeso = document.getElementById('pesoChart').getContext('2d');
                pesoChartInstance = new Chart(ctxPeso, {
                    type: 'line',
                    data: { labels: [], datasets: [{
                        label: 'Peso (kg)',
                        data: [],
                        borderColor: 'rgb(4, 120, 87)',
                        backgroundColor: 'rgba(4, 120, 87, 0.1)',
                        fill: true,
                        tension: 0.1
                    }] },
                    options: chartOptions
                });

                const ctxMedidas = document.getElementById('medidasChart').getContext('2d');
                medidasChartInstance = new Chart(ctxMedidas, {
                    type: 'line',
                    data: { labels: [], datasets: [
                        {
                            label: 'Cintura (cm)',
                            data: [],
                            borderColor: 'rgb(13, 148, 136)',
                            backgroundColor: 'rgba(13, 148, 136, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Quadril (cm)',
                            data: [],
                            borderColor: 'rgb(8, 145, 178)',
                            backgroundColor: 'rgba(8, 145, 178, 0.1)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Bra√ßo (cm)',
                            data: [],
                            borderColor: 'rgb(6, 182, 212)',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            fill: false,
                            tension: 0.1
                        }
                    ] },
                    options: chartOptions
                });
            }
            
            function updateCharts() {
                if (!pesoChartInstance || !medidasChartInstance) initCharts();

                const labels = medicoesData.map(d => d.data);
                
                pesoChartInstance.data.labels = labels;
                pesoChartInstance.data.datasets[0].data = medicoesData.map(d => d.peso);
                pesoChartInstance.update();

                medidasChartInstance.data.labels = labels;
                medidasChartInstance.data.datasets[0].data = medicoesData.map(d => d.cintura);
                medidasChartInstance.data.datasets[1].data = medicoesData.map(d => d.quadril);
                medidasChartInstance.data.datasets[2].data = medicoesData.map(d => d.braco);
                medidasChartInstance.update();
            }
        });
    </script>
</body>
</html>
